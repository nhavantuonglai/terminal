---
import '../assets/style.css';
---

<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Terminal Chat - Ẩn Danh</title>
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  
  <div class="terminal-container">
    
    <div class="terminal-header">
      <div class="terminal-title">
        <div class="terminal-dots">
          <div class="dot red"></div>
          <div class="dot yellow"></div>
          <div class="dot green"></div>
        </div>
        <span class="terminal-name" id="room-name">chat@global</span>
      </div>
      <div class="terminal-info" id="user-info">Đang kết nối...</div>
    </div>

    <div class="terminal-output" id="terminal-output">
      <div class="welcome-screen">
        <h2>Global Anonymous Chat</h2>
        <p>Chào mừng đến với chat ẩn danh toàn cầu<br>Giới hạn: Mỗi user chỉ được gửi tin nhắn mỗi 10 giây<br>Định dạng: YYYY MM DD, HH MM SS | IP: tin nhắn</p>
      </div>
    </div>

    <div class="terminal-input-wrapper">
      <div class="terminal-input-container">
        <span class="terminal-prompt">></span>
        <input 
          type="text" 
          id="message-input" 
          class="terminal-input" 
          placeholder="Nhập tin nhắn..." 
          autocomplete="off"
        >
      </div>
      <button id="send-btn" class="send-btn">GỬI</button>
    </div>
    
    <div class="status-bar">
      <div class="status-left">
        <div class="status-item">
          <div class="status-indicator online" id="connection-status"></div>
          <span id="status-text">Disconnected</span>
        </div>
        <div class="status-item">
          <span>Users: </span>
          <span id="online-count">0</span>
        </div>
      </div>
      <div class="status-right">
        <span>UTF-8</span>
      </div>
    </div>

  </div>

  <script type="module">
    import { io } from "https://cdn.socket.io/4.4.1/socket.io.esm.min.js";
    
    // --- CẤU HÌNH FIX CỨNG ---
    const API_KEY = "87aa8f284fb4f6";
    // Đã thay thế biến môi trường bằng link Render của bạn
    const SERVER_URL = "https://te-b1id.onrender.com"; 
    
    const RATE_LIMIT_SECONDS = 10;
    // --------------------------

    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const terminalOutput = document.getElementById('terminal-output');
    const connectionStatus = document.getElementById('connection-status');
    const statusText = document.getElementById('status-text');
    const onlineCount = document.getElementById('online-count');
    const userInfo = document.getElementById('user-info');
    
    let currentUser = {
      ip: '...',
      city: 'Unknown'
    };
    
    let lastMessageTime = 0;

    // Lấy IP người dùng
    async function fetchUserIP() {
      try {
        const response = await fetch(`https://ipinfo.io/json?token=${API_KEY}`);
        const data = await response.json();
        currentUser = {
          ip: data.ip,
          city: data.city || 'Unknown'
        };
        userInfo.textContent = `${currentUser.ip} @ ${currentUser.city}`;
      } catch (error) {
        console.error('Error fetching IP:', error);
        userInfo.textContent = 'Anonymous User';
      }
    }

    // Kết nối Socket.IO
    // Thêm transports để đảm bảo kết nối ổn định hơn
    const socket = io(SERVER_URL, {
      transports: ['websocket', 'polling'] 
    });

    socket.on('connect', () => {
      connectionStatus.classList.remove('offline');
      connectionStatus.classList.add('online');
      statusText.textContent = 'Connected';
      socket.emit('join room', 'global');
    });

    socket.on('disconnect', () => {
      connectionStatus.classList.remove('online');
      connectionStatus.classList.add('offline');
      statusText.textContent = 'Disconnected';
    });
    
    // Xử lý khi nhận lịch sử tin nhắn
    socket.on('history', (messages) => {
      // Xóa tin nhắn cũ trừ welcome screen
      const welcome = document.querySelector('.welcome-screen');
      terminalOutput.innerHTML = '';
      if(welcome) terminalOutput.appendChild(welcome);
      
      messages.forEach(msg => renderMessage(msg));
      scrollToBottom();
    });

    // Nhận tin nhắn mới
    socket.on('chat message', (msg) => {
      renderMessage(msg);
      scrollToBottom();
    });

    function renderMessage(msg) {
      const div = document.createElement('div');
      div.className = 'message-line';
      
      // Format time
      const date = new Date(msg.timestamp);
      const timeStr = date.toLocaleString('vi-VN', { 
        year: 'numeric', month: '2-digit', day: '2-digit',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false 
      }).replace(',', ''); // Xóa dấu phẩy thừa nếu có
      
      div.innerHTML = `
        <span class="timestamp">[${timeStr}]</span>
        <span class="user-info">${msg.ip} (${msg.city}):</span>
        <span class="message-content">${escapeHtml(msg.text)}</span>
      `;
      
      terminalOutput.appendChild(div);
    }
    
    function scrollToBottom() {
      terminalOutput.scrollTop = terminalOutput.scrollHeight;
    }

    function escapeHtml(text) {
      if (!text) return "";
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }
    
    function updateCooldownUI() {
      const now = Date.now();
      const timeSinceLast = (now - lastMessageTime) / 1000;
      
      if (timeSinceLast < RATE_LIMIT_SECONDS) {
        const remaining = Math.ceil(RATE_LIMIT_SECONDS - timeSinceLast);
        messageInput.placeholder = `Vui lòng đợi ${remaining}s...`;
        sendBtn.disabled = true;
        sendBtn.style.opacity = '0.5';
        setTimeout(updateCooldownUI, 1000);
      } else {
        messageInput.placeholder = "Nhập tin nhắn...";
        sendBtn.disabled = false;
        sendBtn.style.opacity = '1';
      }
    }

    function checkRateLimit() {
      const now = Date.now();
      if ((now - lastMessageTime) < (RATE_LIMIT_SECONDS * 1000)) {
        return false;
      }
      return true;
    }

    // Gửi tin nhắn
    function sendMessage() {
      const text = messageInput.value.trim();
      
      if (!text) return;
      if (!checkRateLimit()) return;
      
      socket.emit('chat message', {
        room: 'global',
        text: text,
        ip: currentUser.ip,
        city: currentUser.city
        // timestamp để server tự tạo
      });
      
      messageInput.value = '';
      messageInput.focus();
      lastMessageTime = Date.now();
      updateCooldownUI();
    }

    // Event listeners
    messageInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    sendBtn.addEventListener('click', sendMessage);

    // Init
    fetchUserIP();
    messageInput.focus();

  </script>
</body>
</html>